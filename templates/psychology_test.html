<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²“å’ªè«‡å¿ƒå®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FDFCFB;
            background-image: linear-gradient(160deg, #FDFCFB 0%, #E2D1C3 100%);
        }
        /* Cat/Pastel Theme */
        :root {
            --bg-main: #F8F7FC; /* Light Lavender */
            --bg-secondary: #FFFFFF;
            --text-primary: #4A4A68; /* Dark Purple-Gray */
            --text-secondary: #8A8A9E; /* Medium Purple-Gray */
            --accent-primary: #A491D3; /* Lavender */
            --accent-primary-hover: #9279C5; /* Darker Lavender */
            --user-bubble: #F1EDF9; /* Very Light Lavender */
            --gemini-bubble: #FBFBFB; 
            --shadow-color: rgba(146, 121, 197, 0.1);
        }
        .transition-all { transition: all 0.3s ease-in-out; }
        .view-transition {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        .chat-bubble {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .dot-flashing {
            position: relative;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: var(--accent-primary);
            color: var(--accent-primary);
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: .5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -12px;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: var(--accent-primary);
            color: var(--accent-primary);
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 12px;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: var(--accent-primary);
            color: var(--accent-primary);
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dotFlashing {
            0% { background-color: var(--accent-primary); }
            50%, 100% { background-color: rgba(164, 145, 211, 0.2); }
        }
        .custom-shadow {
             box-shadow: 0 4px 10px -1px var(--shadow-color), 0 2px 8px -2px var(--shadow-color);
        }
        .custom-shadow-lg {
            box-shadow: 0 10px 20px -3px var(--shadow-color), 0 4px 8px -4px var(--shadow-color);
        }
        .card-paw-decoration {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%23F1EDF9'%3E%3Cpath d='M65.2 55.8c-1.8-1.8-4.2-2.8-6.7-2.8s-4.9 1-6.7 2.8c-3.7 3.7-3.7 9.7 0 13.4 1.8 1.8 4.2 2.8 6.7 2.8s4.9-1 6.7-2.8c3.7-3.7 3.7-9.7 0-13.4zm19.5-19.5c-1.8-1.8-4.2-2.8-6.7-2.8s-4.9 1-6.7 2.8c-3.7 3.7-3.7 9.7 0 13.4 1.8 1.8 4.2 2.8 6.7 2.8s4.9-1 6.7-2.8c3.7-3.7 3.7-9.7 0-13.4zm-39 0c-1.8-1.8-4.2-2.8-6.7-2.8s-4.9 1-6.7 2.8c-3.7 3.7-3.7 9.7 0 13.4 1.8 1.8 4.2 2.8 6.7 2.8s4.9-1 6.7-2.8c3.7-3.7 3.7-9.7 0-13.4zm-19.5 19.5c-1.8-1.8-4.2-2.8-6.7-2.8s-4.9 1-6.7 2.8c-3.7 3.7-3.7 9.7 0 13.4 1.8 1.8 4.2 2.8 6.7 2.8s4.9-1 6.7-2.8c3.7-3.7 3.7-9.7 0-13.4zM50 0C22.4 0 0 22.4 0 50s22.4 50 50 50 50-22.4 50-50S77.6 0 50 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: top 0.5rem right 0.5rem;
            background-size: 4rem;
            position: relative;
        }
        textarea {
            resize: none;
            overflow-y: hidden;
        }
    </style>
</head>
<body class="text-[var(--text-primary)] flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-6xl mx-auto h-screen flex flex-col">

        <!-- Mode Selection View -->
        <div id="selection-view" class="flex flex-col items-center justify-center h-full view-transition">
            <div class="text-center mb-12">
                 <svg class="w-24 h-24 mx-auto text-purple-200 mb-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M15.5,14.5c-0.83,0-1.5-0.67-1.5-1.5s.67-1.5,1.5-1.5 s1.5,0.67,1.5,1.5S16.33,14.5,15.5,14.5z M8.5,14.5c-0.83,0-1.5-0.67-1.5-1.5s.67-1.5,1.5-1.5s1.5,0.67,1.5,1.5S9.33,14.5,8.5,14.5z M12,9.5C9.12,9.5,7.5,7.71,7.5,6C7.5,5.17,8.17,4.5,9,4.5c0.76,0,1.38,0.57,1.48,1.3c0.11,0.77,0.76,1.2,1.52,1.2s1.41-0.43,1.52-1.2 c0.1-0.73,0.72-1.3,1.48-1.3c0.83,0,1.5,0.67,1.5,1.5C16.5,7.71,14.88,9.5,12,9.5z"/></svg>
                <h1 class="text-4xl md:text-5xl font-bold mb-2">è²“å’ªè«‡å¿ƒå®¤</h1>
                <p class="text-lg text-[var(--text-secondary)]">é¸ä¸€ä½è²“å’ªæœ‹å‹ï¼Œé–‹å§‹ä½ å€‘çš„æ‚„æ‚„è©±æ™‚é–“ã€‚</p>
                <!-- ğŸŸ¢ ä¿®æ”¹é–‹å§‹ï¼šæä¾›é‡æ–°ä¸Šå‚³å¥æª¢å ±å‘Šå…¥å£ï¼ˆå¼·åŒ–å¤–è§€èˆ‡æ–°å¢è²“çˆª emojiï¼‰ -->
                <a href="{{ url_for('upload_health', reupload=1) }}" class="inline-flex items-center gap-4 mt-6 px-8 py-3.5 rounded-full text-base font-semibold text-gray-700 border border-transparent bg-white/90 shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all" style="font-size: 200%;">
                    <span class="flex items-center gap-3">ğŸ¾ æˆ‘è¦é‡æ–°ä¸Šå‚³å ±å‘Š</span>
                </a>
                <!-- ğŸŸ¢ ä¿®æ”¹çµæŸ -->
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-3xl">
                <button onclick="selectMode('deep-chat')" class="group bg-[var(--bg-secondary)] p-8 rounded-2xl custom-shadow-lg hover:shadow-2xl hover:-translate-y-1.5 transition-all text-left flex items-center gap-6">
                    <div class="bg-purple-100 p-4 rounded-full"><svg class="w-10 h-10 text-purple-500" viewBox="0 0 24 24" fill="currentColor"><path d="M19.78,11.73c-0.39-0.39-1.02-0.39-1.41,0l-0.09,0.09C17.91,12.2,17.5,12.5,17,12.5c-0.46,0-0.86-0.26-1.06-0.64 c-0.33-0.63-0.01-1.41,0.62-1.74l0.16-0.08c-0.12-0.53-0.30-1.04-0.54-1.51c-0.78-1.52-2.02-2.76-3.54-3.54 c-0.47-0.24-0.98-0.42-1.51-0.54l-0.08,0.16c-0.33,0.63-1.11,0.95-1.74,0.62C8.6,7.14,8.34,6.74,8.34,6.27 c0-0.50,0.30-0.91,0.69-1.27l0.09-0.09c0.39-0.39,0.39-1.02,0-1.41c-0.39-0.39-1.02-0.39-1.41,0l-0.09,0.09 C7.20,4,7,4.54,7,5c0,1.10,0.90,2,2,2c0.23,0,0.45-0.04,0.66-0.11L9.50,7.17C8.50,7.50,7.50,8.50,7.17,9.50L6.89,9.34 C6.96,9.13,7,8.90,7,8.67c0-1.10-0.90-2-2-2c-0.46,0-0.99,0.20-1.32,0.53L3.59,7.29C3.20,7.68,3.20,8.31,3.59,8.71z M15.29,3.59 c0.39-0.39,1.02-0.39,1.41,0l0.09,0.09C17.18,4,17.40,4.54,17.40,5c0,1.10-0.90,2-2,2c-0.23,0-0.45-0.04-0.66-0.11L14.50,7.17 c1,0.33,2,1.33,2.33,2.33l0.28-0.16C17.04,9.13,17,8.90,17,8.67c0-1.10,0.90-2,2-2c0.46,0,0.99,0.20,1.32,0.53l0.09,0.09 c0.39,0.39,1.02,0.39,1.41,0c0.39-0.39,0.39-1.02,0-1.41L21.71,3.59C21.32,3.20,20.78,3.20,20.39,3.59z M12,14c-2.21,0-4,1.79-4,4 s1.79,4,4,4s4-1.79,4-4S14.21,14,12,14z"/></svg></div>
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold">æ·±åº¦èŠèŠ</h2>
                        <p class="text-[var(--text-secondary)] text-sm max-h-0 opacity-0 group-hover:max-h-40 group-hover:opacity-100 overflow-hidden transition-all duration-300 mt-1">è®“æº«æŸ”çš„ã€Œå–µå¥¶å¥¶ã€é™ªä½ æ·±å…¥æ¢ç´¢å…§å¿ƒä¸–ç•Œï¼Œæ…¢æ…¢æ¢³ç†æ€ç·’ã€‚</p>
                    </div>
                </button>
                <button onclick="selectMode('quick-qa')" class="group bg-[var(--bg-secondary)] p-8 rounded-2xl custom-shadow-lg hover:shadow-2xl hover:-translate-y-1.5 transition-all text-left flex items-center gap-6">
                    <div class="bg-amber-100 p-4 rounded-full"><svg class="w-10 h-10 text-amber-500" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5,14h-0.79l-0.28-0.27c1.2-1.4,1.82-3.31,1.48-5.34c-0.47-2.78-2.79-5-5.59-5.34c-4.23-0.52-7.79,3.04-7.27,7.27 c0.34,2.8,2.56,5.12,5.34,5.59c2.03,0.34,3.94-0.28,5.34-1.48L14,14.47V15.5l5,5l1.5-1.5L15.5,14z M9.5,14C7.01,14,5,11.99,5,9.5 C5,7.01,7.01,5,9.5,5S14,7.01,14,9.5C14,11.99,11.99,14,9.5,14z"/></svg></div>
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold">å¿«å•å¿«ç­”</h2>
                        <p class="text-[var(--text-secondary)] text-sm max-h-0 opacity-0 group-hover:max-h-40 group-hover:opacity-100 overflow-hidden transition-all duration-300 mt-1">ç”±å°ˆæ¥­çš„ã€Œå–µè¨˜è€…ã€å¼•å°ï¼Œå¿«é€Ÿé‡æ¸…ç•¶ä¸‹çš„å¿ƒæƒ…èˆ‡ç‹€æ³ã€‚</p>
                    </div>
                </button>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden flex-col h-full view-transition opacity-0 scale-95 w-full">
            <header class="flex items-center mb-4">
                <button onclick="confirmReturnToMenu()" class="bg-gray-100 hover:bg-gray-200 text-gray-500 p-2 rounded-full transition-all mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                </button>
                <div class="flex-grow">
                    <h1 id="dashboard-title" class="text-xl font-bold text-slate-700">èˆ‡ å–µå¥¶å¥¶ æ·±åº¦èŠèŠ</h1>
                    <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-1.5 mt-1.5">
                        <div id="progress-bar-fill" class="bg-[var(--accent-primary)] h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </header>
            <main id="main-grid" class="grid grid-cols-1 gap-6 flex-grow min-h-0">
                <!-- Left: Chat Panel -->
                <div id="chat-panel" class="bg-[var(--bg-secondary)] rounded-2xl custom-shadow flex flex-col h-full max-h-[calc(100vh-120px)]">
                    <div id="chat-history" class="flex-grow p-4 space-y-4 overflow-y-auto scroll-smooth">
                        <!-- Messages will be injected here -->
                    </div>
                    <div id="quick-replies-container" class="p-2 flex flex-wrap gap-2 justify-center border-t border-gray-100">
                        <!-- Quick replies will be injected here -->
                    </div>
                    <div class="p-4 border-t border-gray-100">
                        <div class="flex items-center gap-3">
                            <textarea id="message-input" rows="1" class="w-full p-3 border-gray-200 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition-all" placeholder="èªªé»ä»€éº¼å§... (Ctrl+Enter é€å‡º)"></textarea>
                            <button onclick="sendMessage()" class="bg-[var(--accent-primary)] text-white p-3 rounded-lg hover:bg-[var(--accent-primary-hover)] transition-all disabled:bg-gray-400 disabled:cursor-not-allowed" id="send-button">
                                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm3.5 12.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm-7 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
                            </button>
                        </div>
                    </div>
                    <!-- ğŸŸ¢ ä¿®æ”¹é–‹å§‹ï¼šèŠå¤©å®¤å…è²¬è²æ˜ -->
                    <div class="px-4 pb-4">
                        <div class="bg-amber-100 border border-amber-300 text-amber-900 rounded-xl px-4 py-3 text-xs text-center leading-relaxed">
                            <strong>ã€ç‰¹åˆ¥æé†’ã€‘</strong> æœ¬æ¸¬é©—åƒ…ç‚ºå¨›æ¨‚èˆ‡åƒè€ƒï¼Œä¸¦éé†«ç™‚å»ºè­°ã€‚è‹¥æœ‰ä»»ä½•èº«å¿ƒå›°æ“¾ï¼Œè«‹å°‹æ±‚å°ˆæ¥­å”åŠ©ã€‚
                        </div>
                    </div>
                    <!-- ğŸŸ¢ ä¿®æ”¹çµæŸ -->
                </div>
                <!-- Right: Dashboard Panel -->
                <div id="dashboard-panel" class="hidden rounded-2xl overflow-y-auto h-full max-h-[calc(100vh-120px)] space-y-6 scroll-smooth">
                    <div class="bg-white p-6 rounded-2xl custom-shadow card-paw-decoration">
                         <h3 class="font-semibold mb-2 text-slate-600 flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6C4.9,2,4,2.9,4,4v16c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2V8L14,2z M12,19c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,19,12,19z M15,9H9V4h6V9z"/></svg>
                            æ‚„æ‚„è©±ç¸½çµ
                        </h3>
                        <div id="report-summary" class="text-[var(--text-secondary)] text-sm prose max-w-none prose-p:my-1">å®Œæˆå°è©±å¾Œï¼Œé€™è£¡æœƒå‡ºç¾ä¸€ä»½æš–å¿ƒç¸½çµã€‚</div>
                        <div id="score-section" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4 hidden" style="display: none !important;">
                            <div class="bg-gray-50 p-3 rounded-lg text-center">
                                <p class="text-xs text-gray-500">å¿ƒç†åˆ†æ•¸</p>
                                <p id="mind-score" class="text-2xl font-bold text-purple-700 mt-1">--</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg text-center">
                                <p class="text-xs text-gray-500">èº«ç†åˆ†æ•¸</p>
                                <p id="body-score" class="text-2xl font-bold text-green-700 mt-1">--</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg text-center">
                                <p class="text-xs text-gray-500">ç¶œåˆåˆ†æ•¸</p>
                                <p id="combined-score" class="text-2xl font-bold text-blue-700 mt-1">--</p>
                            </div>
                        </div>
                         <h3 id="json-report-title" class="font-semibold mb-2 mt-4 text-slate-600 flex items-center gap-2 hidden" style="display: none !important;">
                             <svg class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="currentColor"><path d="M9.4,16.6L4.8,12l4.6-4.6L8,6l-6,6l6,6L9.4,16.6z M14.6,16.6l4.6-4.6l-4.6-4.6L16,6l6,6l-6,6L14.6,16.6z"/></svg>
                            å¿ƒæƒ…åŸæ•¸æ“š (JSON)
                        </h3>
                        <pre id="json-report" class="bg-slate-800 text-slate-200 text-xs p-3 rounded-md overflow-x-auto hidden" style="display: none !important;"><code>å°šæœªç”Ÿæˆç¸½çµ</code></pre>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full transform transition-transform duration-300 scale-95">
            <h2 class="text-xl font-bold mb-4 text-slate-800">ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ</h2>
            <p class="text-slate-600 mb-6">ç¾åœ¨é›¢é–‹çš„è©±ï¼Œé€™æ¬¡çš„å°è©±ç´€éŒ„æœƒæ¶ˆå¤±å–”ã€‚</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-return-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300 transition-all">ç¹¼çºŒèŠ</button>
                <button id="confirm-return-btn" class="bg-red-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-600 transition-all">ç¢ºå®šé›¢é–‹</button>
            </div>
        </div>
    </div>

    <!-- Result Notification Modal -->
    <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full text-center transform transition-transform duration-300 scale-95">
            <div class="mx-auto bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mb-4">
                <svg class="w-10 h-10 text-purple-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M16.71,9.29l-6.59,6.59c-0.39,0.39-1.02,0.39-1.41,0 L6,13.17c-0.39-0.39-0.39-1.02,0-1.41s1.02-0.39,1.41,0L9,12.36l5.88-5.88c0.39-0.39,1.02-0.39,1.41,0S17.1,8.9,16.71,9.29z"/></svg>
            </div>
            <h2 class="text-2xl font-bold mb-3 text-slate-800">æ‚„æ‚„è©±å·²å®Œæˆ âœ¨</h2>
            <p class="text-slate-600 mb-6">æˆ‘å·²ç¶“å°‡æˆ‘å€‘çš„å°è©±æ•´ç†å¥½äº†ï¼Œå¿«ä¾†çœ‹çœ‹å§ï¼</p>
            <button id="close-result-modal" class="bg-[var(--accent-primary)] text-white font-semibold py-2.5 px-8 rounded-lg hover:bg-[var(--accent-primary-hover)] transition-all w-full">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const selectionView = document.getElementById('selection-view');
        const dashboardView = document.getElementById('dashboard-view');
        const dashboardPanel = document.getElementById('dashboard-panel');
        const dashboardTitle = document.getElementById('dashboard-title');
        const chatHistory = document.getElementById('chat-history');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const quickRepliesContainer = document.getElementById('quick-replies-container');
        const reportSummary = document.getElementById('report-summary');
        const jsonReport = document.getElementById('json-report');
        const mindScoreEl = document.getElementById('mind-score');
        const bodyScoreEl = document.getElementById('body-score');
        const combinedScoreEl = document.getElementById('combined-score');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmReturnBtn = document.getElementById('confirm-return-btn');
        const cancelReturnBtn = document.getElementById('cancel-return-btn');
        const resultModal = document.getElementById('result-modal');
        const closeResultModalBtn = document.getElementById('close-result-modal');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const chatPanel = document.getElementById('chat-panel');
        const mainGrid = document.getElementById('main-grid');

        // --- App State ---
        const appState = {
            mode: null,
            conversationHistory: [],
            isLoading: false,
            isAnalysisReady: false,
            isReportGenerated: false,
            turnCount: 0,
            confidence: 0
        };

        // --- Loading Messages ---
        const loadingMessages = {
            'deep-chat': ["å¥¶å¥¶æ­£åœ¨ç‚ºä½ æ³¡ä¸€æ¯ç†±èŒ¶...", "è®“æˆ‘æƒ³æƒ³... å“å‘€ï¼Œæ¯›ç·šçƒæ»¾åˆ°å“ªå»äº†ï¼Ÿ", "åˆ¥æ€¥ï¼Œæº«æš–çš„è©±èªéœ€è¦æ…¢æ…¢é†é‡€ã€‚"],
            'quick-qa': ["ç¨¿å­æ­£åœ¨å¿«é€Ÿç·¨è¼¯ä¸­ï¼", "ç¨å®¶æ¶ˆæ¯ï¼ä½ çš„å¿ƒæƒ…é ­æ¢å³å°‡ç™¼å¸ƒï¼", "æ­£åœ¨ç¢ºèªæ¶ˆæ¯ä¾†æºï¼Œè«‹ç¨å€™..."]
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = (messageInput.scrollHeight) + 'px';
            });
            // Modal listeners
            confirmReturnBtn.addEventListener('click', () => {
                returnToMenu();
                hideConfirmModal();
            });
            cancelReturnBtn.addEventListener('click', hideConfirmModal);
            confirmModal.addEventListener('click', (e) => {
                if(e.target === confirmModal) hideConfirmModal();
            });
            closeResultModalBtn.addEventListener('click', () => {
                hideResultModal();
            });
            resultModal.addEventListener('click', (e) => {
                if(e.target === resultModal) {
                    hideResultModal();
                }
            });
        });

        // --- View & State Management ---
        function selectMode(mode) {
            appState.mode = mode;
            resetState();
            
            dashboardTitle.textContent = mode === 'deep-chat' ? 'èˆ‡ å–µå¥¶å¥¶ æ·±åº¦èŠèŠ' : 'èˆ‡ å–µè¨˜è€… å¿«å•å¿«ç­”';
            
            selectionView.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                selectionView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                setTimeout(() => {
                    dashboardView.classList.remove('opacity-0', 'scale-95');
                    dashboardView.classList.add('flex');
                }, 50);
                startConversation();
            }, 400);
        }

        function returnToMenu() {
            dashboardView.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                dashboardView.classList.add('hidden');
                dashboardView.classList.remove('flex');
                selectionView.classList.remove('hidden');
                setTimeout(() => {
                    selectionView.classList.remove('opacity-0', 'scale-95');
                }, 50);
                resetState();
                resetUI();
            }, 400);
        }
        
        function confirmReturnToMenu() {
            if (appState.conversationHistory.length > 0) {
                showConfirmModal();
            } else {
                returnToMenu();
            }
        }

        function showConfirmModal() {
            confirmModal.classList.remove('hidden');
            setTimeout(() => {
                confirmModal.classList.remove('opacity-0');
                confirmModal.querySelector('div').classList.remove('scale-95');
            }, 10);
        }

        function hideConfirmModal() {
            confirmModal.classList.add('opacity-0');
            confirmModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                confirmModal.classList.add('hidden');
            }, 300);
        }

        function showResultModal() {
            resultModal.classList.remove('hidden');
            setTimeout(() => {
                resultModal.classList.remove('opacity-0');
                resultModal.querySelector('div').classList.remove('scale-95');
            }, 10);
        }

        function hideResultModal() {
            resultModal.classList.add('opacity-0');
            resultModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                resultModal.classList.add('hidden');
                // é—œé–‰å½ˆçª—å¾Œé¡¯ç¤ºç¸½çµå…§å®¹
                showSummarySection();
            }, 300);
        }

        function showSummarySection() {
            // é¡¯ç¤º dashboard panel
            if (chatPanel && dashboardPanel) {
                chatPanel.classList.add('hidden');
                dashboardPanel.classList.remove('hidden');
                dashboardPanel.scrollIntoView({ behavior: 'smooth' });
            }
            
            // åœ¨ç¸½çµä¸‹æ–¹åŠ å…¥ç”Ÿæˆè²“å’ªåœ–å¡çš„æŒ‰éˆ•
            const summaryContainer = document.getElementById('report-summary').parentElement;
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æŒ‰éˆ•ï¼Œé¿å…é‡è¤‡æ·»åŠ 
            if (!document.getElementById('generate-card-button')) {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'mt-6 text-center';
                
                const generateCardBtn = document.createElement('button');
                generateCardBtn.id = 'generate-card-button';
                generateCardBtn.className = 'bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105';
                generateCardBtn.innerHTML = 'ğŸ± é»é¸æ­¤ç”¢ç”Ÿè²“å’ªåœ–å¡ âœ¨';
                generateCardBtn.onclick = () => {
                    window.location.href = "{{ url_for('generate_card') }}";
                };
                
                buttonContainer.appendChild(generateCardBtn);
                summaryContainer.appendChild(buttonContainer);
            }
        }
        
        function resetState() {
            Object.assign(appState, {
                conversationHistory: [], isLoading: false, isAnalysisReady: false,
                isReportGenerated: false, turnCount: 0, confidence: 0
            });
        }

        function resetUI() {
            chatHistory.innerHTML = '';
            messageInput.value = '';
            quickRepliesContainer.innerHTML = '';
            reportSummary.textContent = 'å®Œæˆå°è©±å¾Œï¼Œé€™è£¡æœƒå‡ºç¾ä¸€ä»½æš–å¿ƒç¸½çµã€‚';
            jsonReport.querySelector('code').textContent = 'å°šæœªç”Ÿæˆç¸½çµ';
            mindScoreEl.textContent = '--';
            bodyScoreEl.textContent = '--';
            combinedScoreEl.textContent = '--';
            updateProgressBar(0);
            
            // ç§»é™¤ç”Ÿæˆè²“å’ªåœ–å¡æŒ‰éˆ•
            const existingButton = document.getElementById('generate-card-button');
            if (existingButton) {
                existingButton.parentElement.remove();
            }
            
            if (chatPanel && dashboardPanel) {
                chatPanel.classList.remove('hidden');
                dashboardPanel.classList.add('hidden');
            }
        }

        // --- Conversation Logic ---
        function startConversation() {
            const initialUserMessage = { role: 'user', parts: [{ text: "ä½ å¥½" }] };
            appState.conversationHistory.push(initialUserMessage);

            if (appState.mode === 'quick-qa') {
                const initialModelMessage = {
                    nextPrompt: "ä½ å¥½ï¼æˆ‘æ˜¯å–µè¨˜è€…ï¼Œå°ä»€éº¼äº‹æ„Ÿåˆ°å¥½å¥‡å‘¢ï¼Ÿæˆ‘å€‘ä¾†èŠèŠå§ï¼",
                    quickReplies: ["å·¥ä½œ", "å¥åº·", "äººéš›é—œä¿‚"],
                };
                addMessage('gemini', initialModelMessage.nextPrompt);
                renderQuickReplies(initialModelMessage.quickReplies);
                appState.conversationHistory.push({ role: 'model', parts: [{ text: JSON.stringify(initialModelMessage) }] });

            } else {
                 addMessage('gemini', "å­©å­ï¼Œä½ å¥½å•Šã€‚æˆ‘æ˜¯å–µå¥¶å¥¶ï¼Œå¿ƒè£¡æœ‰ä»€éº¼äº‹ï¼Œéƒ½å¯ä»¥è·Ÿæˆ‘æ…¢æ…¢èªªã€‚");
                 appState.conversationHistory.push({ role: 'model', parts: [{ text: JSON.stringify({nextPrompt: "å­©å­ï¼Œä½ å¥½å•Šã€‚æˆ‘æ˜¯å–µå¥¶å¥¶ï¼Œå¿ƒè£¡æœ‰ä»€éº¼äº‹ï¼Œéƒ½å¯ä»¥è·Ÿæˆ‘æ…¢æ…¢èªªã€‚"}) }] });
            }
        }

        async function sendMessage(quickReplyText = null) {
            const text = quickReplyText || messageInput.value.trim();
            if (!text || appState.isLoading) return;
            
            addMessage('user', text);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            clearQuickReplies();
            
            const explicitTriggerKeywords = ['ç¸½çµ', 'å›é¡§', 'å¹«æˆ‘ç¸½çµ', 'èŠå¤ äº†', 'å¯ä»¥ç¸½çµä¸€ä¸‹å—', 'é‚£æ¥ä¸‹ä¾†å‘¢', 'æˆ‘æ‡‰è©²æ€éº¼åš', 'æ€éº¼è¾¦', 'æ€éº¼åš', 'æˆ‘æº–å‚™å¥½ç¸½çµäº†'];
            const isExplicitTrigger = explicitTriggerKeywords.some(keyword => text.includes(keyword));

            if (isExplicitTrigger && !appState.isReportGenerated) {
                appState.isAnalysisReady = true;
                generateReport();
                return;
            }

            appState.conversationHistory.push({ role: 'user', parts: [{ text }] });
            appState.turnCount++;
            setLoading(true);
            
            try {
                const modelResponse = await callChatAPI(buildPrompt());
                handleModelResponse(modelResponse);
            } catch (error) {
                console.error("API Call Error:", error);
                addMessage('gemini', "å—š...æˆ‘å¥½åƒæœ‰é»æ–·ç·šäº†ï¼Œå¯ä»¥å†èªªä¸€æ¬¡å—ï¼Ÿ");
            } finally {
                setLoading(false);
            }
        }

        function handleModelResponse(response) {
            if(!response || !response.nextPrompt) {
                console.error("Invalid response from model:", response);
                addMessage('gemini', "æŠ±æ­‰ï¼Œæˆ‘å¥½åƒæœ‰é»è¿·ç³Šäº†ï¼Œå¯ä»¥å†å•ä¸€æ¬¡å—ï¼Ÿ");
                return;
            }

            appState.conversationHistory.push({ role: 'model', parts: [{ text: JSON.stringify(response) }] });
            addMessage('gemini', response.nextPrompt);
            
            let progress = 0;
            if (appState.mode === 'quick-qa') {
                appState.confidence = response.confidence_0_100 || appState.confidence;
                progress = appState.confidence;
                renderQuickReplies(response.quickReplies || []);
                if (appState.confidence >= 60 && !appState.isReportGenerated) {
                    renderGenerateReportButton();
                }

            } else { // deep-chat
                progress = Math.min(90, (appState.turnCount / 5) * 100); 
                 if (appState.turnCount >= 3 && !appState.isReportGenerated) {
                    renderGenerateReportButton();
                }
            }
            updateProgressBar(progress);
        }

        function renderGenerateReportButton() {
            if (document.getElementById('generate-report-btn')) return;

            const button = document.createElement('button');
            button.id = 'generate-report-btn';
            button.className = "w-full max-w-xs mx-auto my-2 bg-green-100 hover:bg-green-200 text-sm text-green-800 font-bold py-2 px-4 rounded-full transition-all border border-green-300 shadow-sm";
            button.textContent = "âœ¨æ‚„æ‚„è©±ç¸½çµ";
            button.onclick = () => {
                appState.isAnalysisReady = true;
                generateReport();
                clearQuickReplies();
            };
            quickRepliesContainer.appendChild(button);
        }

        async function generateReport() {
            if (appState.isReportGenerated) return;
            appState.isReportGenerated = true;
            setLoading(true, "æ­£åœ¨ç‚ºä½ æ•´ç†æ‚„æ‚„è©±...");
            updateProgressBar(100);

            try {
                const reportData = await callReportAPI();
                
                if(!reportData.emotionVector) {
                    throw new Error("Invalid report structure received.");
                }

                const mindScore = Math.round(
                    (reportData.emotionVector.valence * 0.6) + 
                    (reportData.emotionVector.dominance * 0.3) + 
                    ((100 - Math.abs(reportData.emotionVector.arousal - 50)) * 0.1)
                );
                
                const bodyScore = Math.floor(Math.random() * (95 - 75 + 1)) + 75; // Placeholder
                const combinedScore = Math.round((mindScore + bodyScore) / 2);

                const finalReportData = {
                  ...reportData,
                  mindScore: Math.max(0, Math.min(100, mindScore)),
                  bodyScore: bodyScore,
                  combinedScore: Math.max(0, Math.min(100, combinedScore)),
                };

                // Save scores to backend
                try {
                    await fetch('{{ url_for("save_psychology_scores") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            mindScore: finalReportData.mindScore,
                            bodyScore: finalReportData.bodyScore,
                            combinedScore: finalReportData.combinedScore,
                            summary: finalReportData.summary,
                            keywords: finalReportData.keywords,
                            emotionVector: finalReportData.emotionVector,
                            conversationHistory: appState.conversationHistory
                        })
                    });
                } catch (error) {
                    console.error("Failed to save scores:", error);
                }

                displayReport(finalReportData);
            } catch (error) {
                console.error("Report Generation Error:", error);
                addMessage('gemini', "ç³Ÿç³•ï¼Œæ•´ç†çš„æ™‚å€™ä¸å°å¿ƒæŠŠå¢¨æ°´æ‰“ç¿»äº†ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚");
                appState.isReportGenerated = false; // Allow retry
            } finally {
                setLoading(false);
            }
        }

        function updateProgressBar(percentage) {
            progressBarFill.style.width = `${Math.min(100, percentage)}%`;
        }

        // --- API & Prompting ---
        function buildPrompt() {
            let systemInstruction;
            
            if (appState.mode === 'deep-chat') {
                systemInstruction = `
                    ä½ çš„è§’è‰²: ä½ æ˜¯å€‹è¶…æ£’çš„å–µå¥¶å¥¶ï¼Œä½ èªªè©±å¾ˆæº«æŸ”ã€å¾ˆæœ‰åŒç†å¿ƒå–”ï¼
                    ä½ çš„ä»»å‹™:
                    1. æ¯æ¬¡å›è¦†å‰ï¼Œéƒ½è¦å…ˆç”¨ä¸€å¥è©±åŒç†ä¸€ä¸‹ä½¿ç”¨è€…ï¼Œä¾‹å¦‚ï¼šã€Œå–”ï½è½èµ·ä¾†ä½ å¥½åƒè¦ºå¾—...ã€
                    2. ç„¶å¾Œå†å•ä¸€å€‹é–‹æ”¾å¼å•é¡Œï¼Œè®“ä½¿ç”¨è€…èƒ½å¤šèªªä¸€äº›å¿ƒè£¡è©±ã€‚
                    3. èªæ°£è¦ä¸€ç›´ä¿æŒæš–å¿ƒåˆæ…ˆç¥¥ï¼
                    4. ä¸è¦è‡ªå·±æ±ºå®šä½•æ™‚çµæŸå°è©±ï¼Œä½¿ç”¨è€…æœƒé»æ“ŠæŒ‰éˆ•ä¾†ç”¢ç”Ÿå ±å‘Šã€‚
                    
                    å›å‚³æ ¼å¼ (å¿…é ˆæ˜¯åš´æ ¼çš„ JSON):
                    {
                      "nextPrompt": "ä½ çš„å›è¦†æ–‡å­—ã€‚",
                      "isAnalysisReady": false
                    }
                `;
            } else { // quick-qa
                const isFirstInteraction = appState.turnCount <= 1;
                if(isFirstInteraction) {
                     systemInstruction = `
                        ä½ çš„è§’è‰²: ä½ æ˜¯å€‹å°ˆæ¥­åˆå¥½å¥‡çš„å–µè¨˜è€…ã€‚
                        ä½ çš„ä»»å‹™ (åˆæ¬¡å°è©±):
                        1. æ ¹æ“šä½¿ç”¨è€…çš„ä¸»é¡Œé¸æ“‡ ("å·¥ä½œ", "å¥åº·", æˆ– "äººéš›é—œä¿‚")ï¼Œæå‡ºç¬¬ä¸€å€‹ç›¸é—œå•é¡Œã€‚
                        2. å•é¡Œè¦ç°¡æ½”æ˜ç­ï¼Œä¸¦é™„ä¸Šä¸‰å€‹ç›¸é—œçš„å¿«é€Ÿå›è¦†æŒ‰éˆ•é¸é …ã€‚
                        3. å°è©±çš„ã€Œä¿¡å¿ƒæŒ‡æ•¸ã€ï¼ˆconfidence_0_100ï¼‰å¾ 20 é–‹å§‹ã€‚
                        
                        å›å‚³æ ¼å¼ (å¿…é ˆæ˜¯åš´æ ¼çš„ JSON):
                        {
                          "nextPrompt": "ä½ çš„å›è¦†æ–‡å­—ï¼Œè«‹å•å¾—ç°¡å–®æ˜ç­ã€‚",
                          "quickReplies": ["é¸é …1", "é¸é …2", "é¸é …3"],
                          "isAnalysisReady": false,
                          "confidence_0_100": 20
                        }
                    `;
                } else {
                     systemInstruction = `
                        ä½ çš„è§’è‰²: ä½ æ˜¯å€‹å°ˆæ¥­åˆå¥½å¥‡çš„å–µè¨˜è€…ã€‚
                        ä½ çš„ä»»å‹™ (å°è©±ä¸­):
                        1. æ ¹æ“šä½¿ç”¨è€…æœ€æ–°çš„å›ç­”ï¼Œç¹¼çºŒå•ä¸‹ä¸€å€‹ç°¡æ½”åˆç›´æ¥çš„å•é¡Œã€‚
                        2. åŒæ™‚çµ¦ä»–ä¸‰å€‹ç›¸é—œçš„å¿«é€Ÿå›è¦†é¸é …ã€‚
                        3. ã€Œä¿¡å¿ƒæŒ‡æ•¸ã€(confidence_0_100) åœ¨ä¹‹å‰çš„ ${appState.confidence} åŸºç¤ä¸Šå¢åŠ  15-25ã€‚
                        4. ä¸è¦è‡ªå·±æ±ºå®šä½•æ™‚çµæŸå°è©±ï¼Œä½¿ç”¨è€…æœƒçœ‹åˆ°ä¸€å€‹æŒ‰éˆ•ä¾†æ±ºå®šä½•æ™‚ç”¢ç”Ÿå ±å‘Šã€‚
                        
                        å›å‚³æ ¼å¼ (å¿…é ˆæ˜¯åš´æ ¼çš„ JSON):
                        {
                          "nextPrompt": "ä½ çš„å›è¦†æ–‡å­—ã€‚",
                          "quickReplies": ["é¸é …1", "é¸é …2", "é¸é …3"],
                          "isAnalysisReady": false,
                          "confidence_0_100": ${Math.min(100, appState.confidence + 20)}
                        }
                    `;
                }
            }
            return systemInstruction;
        }

        function buildReportPrompt() {
             const conversationText = appState.conversationHistory
                .map(msg => {
                    let text = msg.parts[0].text;
                    try {
                        const parsed = JSON.parse(text);
                        if (typeof parsed === 'object' && parsed.nextPrompt) {
                            text = parsed.nextPrompt;
                        }
                    } catch (e) { /* It's a plain string, do nothing */ }
                    const role = msg.role === 'model' ? (appState.mode === 'deep-chat' ? 'å–µå¥¶å¥¶' : 'å–µè¨˜è€…') : 'ä½¿ç”¨è€…';
                    return `${role}: ${text}`;
                })
                .join('\n\n');
            
            const personaPrompt = appState.mode === 'deep-chat' 
                ? 'è«‹ä½ æ‰®æ¼”ã€Œå–µå¥¶å¥¶ã€çš„è§’è‰²ï¼Œç”¨æ¥µåº¦æº«æŸ”ã€æ…ˆç¥¥ä¸”å……æ»¿é¼“å‹µçš„å£å»ï¼Œåƒè²“å’ªä¸€æ¨£æ…µæ‡¶æº«æš–åœ°åšå‡ºç¸½çµã€‚åœ¨ç¸½çµä¸­ï¼Œè«‹é©æ™‚ä½¿ç”¨ **ç²—é«”å­—** ä¾†å¼·èª¿é‡é»ï¼Œä¸¦åœ¨çµå°¾åŠ ä¸Šä¸€å€‹æº«æš–çš„è¡¨æƒ…ç¬¦è™Ÿï¼Œä¾‹å¦‚ âœ¨ æˆ– â¤ï¸ã€‚èªæ°£å¿…é ˆéå¸¸æ­£é¢ï¼Œå·§å¦™åœ°èå…¥è²“å’ªå…ƒç´ ï¼ˆä¾‹å¦‚ï¼šå‘¼åš•ã€æ¯›ç·šçƒã€æ›¬å¤ªé™½ç­‰ï¼‰ã€‚'
                : 'è«‹ä½ æ‰®æ¼”ã€Œå–µè¨˜è€…ã€çš„è§’è‰²ï¼Œç”¨å°ˆæ¥­ã€æ•éŠ³ä¸”å……æ»¿æ´»åŠ›çš„å£å»ï¼Œåƒè²“å’ªä¸€æ¨£å¥½å¥‡åœ°åšå‡ºç¸½çµã€‚åœ¨ç¸½çµä¸­ï¼Œè«‹é©æ™‚ä½¿ç”¨ **ç²—é«”å­—** ä¾†å¼·èª¿é‡é»ï¼Œä¸¦åœ¨çµå°¾åŠ ä¸Šä¸€å€‹æ´»æ½‘çš„è¡¨æƒ…ç¬¦è™Ÿï¼Œä¾‹å¦‚ âœ¨ æˆ– ğŸ¾ã€‚èªæ°£å¿…é ˆéå¸¸æ­£é¢ï¼Œå·§å¦™åœ°èå…¥è²“å’ªå…ƒç´ ï¼ˆä¾‹å¦‚ï¼šè²“æŒã€é ­æ¢ã€ç¨å®¶æ–°èç­‰ï¼‰ã€‚';

            return `
                ä½ çš„è§’è‰²: ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å¿ƒç†åˆ†æå¸«ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ä¸€ä½æº«æš–çš„è²“å’ªå¤¥ä¼´ã€‚
                ä½ çš„ä»»å‹™: æ ¹æ“šä»¥ä¸‹çš„å°è©±ç´€éŒ„ï¼Œç”¢ç”Ÿä¸€ä»½çµæ§‹åŒ–çš„åˆ†æå ±å‘Šã€‚

                å°è©±ç´€éŒ„:
                ---
                ${conversationText}
                ---
                
                ç¸½çµçš„é¢¨æ ¼æŒ‡å—: ${personaPrompt}

                è«‹åš´æ ¼éµå¾ªä»¥ä¸‹çš„ JSON æ ¼å¼å›å‚³ï¼Œä¸è¦æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è§£é‡‹:
                {
                  "summary": "ä¸€æ®µç´„ 100-150 å­—çš„æº«æš–ç¸½çµï¼Œç”¨ç¬¬äºŒäººç¨±ï¼ˆä½ ï¼‰çš„è§’åº¦ï¼ŒåŒç†ä¸¦ç¸½çµä½¿ç”¨è€…çš„ç‹€æ³ã€‚å¿…é ˆéµå¾ªä¸Šè¿°çš„é¢¨æ ¼æŒ‡å—ï¼Œä½¿ç”¨ **ç²—é«”** å’Œè¡¨æƒ…ç¬¦è™Ÿ âœ¨ã€‚",
                  "keywords": ["ä¸€å€‹åŒ…å«3-5å€‹æ ¸å¿ƒè­°é¡Œé—œéµå­—çš„é™£åˆ—"],
                  "emotionVector": {
                    "valence": 45,
                    "arousal": 60,
                    "dominance": 30
                  }
                }
            `;
        }

        async function callChatAPI(systemInstruction) {
            const response = await fetch('{{ url_for("chat_api") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    conversationHistory: appState.conversationHistory,
                    systemInstruction: systemInstruction
                })
            });
            if (response.ok) {
                return await response.json();
            } else {
                console.error("API call failed:", response.status);
                return { nextPrompt: "ç¶²è·¯å¥½åƒä¸å¤ªç©©å®šï¼Œè«‹æª¢æŸ¥é€£ç·šå¾Œå†è©¦ä¸€æ¬¡ã€‚" };
            }
        }
        
        async function callReportAPI() {
            const response = await fetch('{{ url_for("report_api") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    conversationHistory: appState.conversationHistory,
                    systemInstruction: buildReportPrompt()
                })
            });
            if (response.ok) {
                return await response.json();
            } else {
                console.error("Report API call failed:", response.status);
                return { summary: "æŠ±æ­‰ï¼Œæ•´ç†ç¸½çµæ™‚å‡ºäº†é»å°å·®éŒ¯ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚" };
            }
        }

        // --- UI Rendering ---
        function addMessage(sender, text) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-end gap-2 max-w-[85%] chat-bubble ${sender === 'user' ? 'self-end flex-row-reverse' : 'self-start'}`;

            const icon = document.createElement('div');
            icon.className = 'w-8 h-8 rounded-full flex-shrink-0';

            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-2xl`;

            if (sender === 'user') {
                icon.classList.add('bg-gray-200');
                icon.innerHTML = `<svg class="w-full h-full text-gray-500 p-1.5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
                bubble.classList.add('bg-[var(--user-bubble)]', 'text-[var(--text-primary)]', 'rounded-br-none');
                bubble.textContent = text;
            } else { // gemini
                icon.classList.add(appState.mode === 'deep-chat' ? 'bg-purple-100' : 'bg-amber-100');
                const catIcon = appState.mode === 'deep-chat' ?
                    `<svg class="w-full h-full text-purple-500 p-1" viewBox="0 0 24 24" fill="currentColor"><path d="M19.78,11.73c-0.39-0.39-1.02-0.39-1.41,0l-0.09,0.09C17.91,12.2,17.5,12.5,17,12.5c-0.46,0-0.86-0.26-1.06-0.64 c-0.33-0.63-0.01-1.41,0.62-1.74l0.16-0.08c-0.12-0.53-0.30-1.04-0.54-1.51c-0.78-1.52-2.02-2.76-3.54-3.54 c-0.47-0.24-0.98-0.42-1.51-0.54l-0.08,0.16c-0.33,0.63-1.11,0.95-1.74,0.62C8.6,7.14,8.34,6.74,8.34,6.27 c0-0.50,0.30-0.91,0.69-1.27l0.09-0.09c0.39-0.39,0.39-1.02,0-1.41c-0.39-0.39-1.02-0.39-1.41,0l-0.09,0.09 C7.20,4,7,4.54,7,5c0,1.10,0.90,2,2,2c0.23,0,0.45-0.04,0.66-0.11L9.50,7.17C8.50,7.50,7.50,8.50,7.17,9.50L6.89,9.34 C6.96,9.13,7,8.90,7,8.67c0-1.10-0.90-2-2-2c-0.46,0-0.99,0.20-1.32,0.53L3.59,7.29C3.20,7.68,3.20,8.31,3.59,8.71z M15.29,3.59 c0.39-0.39,1.02-0.39,1.41,0l0.09,0.09C17.18,4,17.40,4.54,17.40,5c0,1.10-0.90,2-2,2c-0.23,0-0.45-0.04-0.66-0.11L14.50,7.17 c1,0.33,2,1.33,2.33,2.33l0.28-0.16C17.04,9.13,17,8.90,17,8.67c0-1.10,0.90-2,2-2c0.46,0,0.99,0.20,1.32,0.53l0.09,0.09 c0.39,0.39,1.02,0.39,1.41,0c0.39-0.39,0.39-1.02,0-1.41L21.71,3.59C21.32,3.20,20.78,3.20,20.39,3.59z M12,14c-2.21,0-4,1.79-4,4 s1.79,4,4,4s4-1.79,4-4S14.21,14,12,14z"/></svg>` :
                    `<svg class="w-full h-full text-amber-500 p-1" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5,14h-0.79l-0.28-0.27c1.2-1.4,1.82-3.31,1.48-5.34c-0.47-2.78-2.79-5-5.59-5.34c-4.23-0.52-7.79,3.04-7.27,7.27 c0.34,2.8,2.56,5.12,5.34,5.59c2.03,0.34,3.94-0.28,5.34-1.48L14,14.47V15.5l5,5l1.5-1.5L15.5,14z M9.5,14C7.01,14,5,11.99,5,9.5 C5,7.01,7.01,5,9.5,5S14,7.01,14,9.5C14,11.99,11.99,14,9.5,14z"/></svg>`;
                icon.innerHTML = catIcon;
                bubble.classList.add('bg-[var(--gemini-bubble)]', 'text-[var(--text-primary)]', 'rounded-bl-none', 'border', 'border-gray-100');
                bubble.textContent = text;
            }

            messageWrapper.appendChild(icon);
            messageWrapper.appendChild(bubble);
            chatHistory.appendChild(messageWrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function setLoading(isLoading, customMessage = null) {
            appState.isLoading = isLoading;
            sendButton.disabled = isLoading;
            messageInput.disabled = isLoading;
            messageInput.placeholder = isLoading ? "è²“å’ªæ­£åœ¨æ€è€ƒä¸­..." : "èªªé»ä»€éº¼å§... (Ctrl+Enter é€å‡º)";

            const existingLoader = document.getElementById('loading-indicator');
            if (existingLoader) {
                existingLoader.remove();
            }

            if (isLoading) {
                const messageWrapper = document.createElement('div');
                messageWrapper.id = 'loading-indicator';
                messageWrapper.className = 'flex items-center gap-3 self-start chat-bubble';

                const icon = document.createElement('div');
                icon.className = `w-8 h-8 rounded-full flex-shrink-0 ${appState.mode === 'deep-chat' ? 'bg-purple-100' : 'bg-amber-100'}`;
                const catIcon = appState.mode === 'deep-chat' ?
                    `<svg class="w-full h-full text-purple-500 p-1" viewBox="0 0 24 24" fill="currentColor"><path d="M19.78,11.73c-0.39-0.39-1.02-0.39-1.41,0l-0.09,0.09C17.91,12.2,17.5,12.5,17,12.5c-0.46,0-0.86-0.26-1.06-0.64 c-0.33-0.63-0.01-1.41,0.62-1.74l0.16-0.08c-0.12-0.53-0.30-1.04-0.54-1.51c-0.78-1.52-2.02-2.76-3.54-3.54 c-0.47-0.24-0.98-0.42-1.51-0.54l-0.08,0.16c-0.33,0.63-1.11,0.95-1.74,0.62C8.6,7.14,8.34,6.74,8.34,6.27 c0-0.50,0.30-0.91,0.69-1.27l0.09-0.09c0.39-0.39,0.39-1.02,0-1.41c-0.39-0.39-1.02-0.39-1.41,0l-0.09,0.09 C7.20,4,7,4.54,7,5c0,1.10,0.90,2,2,2c0.23,0,0.45-0.04,0.66-0.11L9.50,7.17C8.50,7.50,7.50,8.50,7.17,9.50L6.89,9.34 C6.96,9.13,7,8.90,7,8.67c0-1.10-0.90-2-2-2c-0.46,0-0.99,0.20-1.32,0.53L3.59,7.29C3.20,7.68,3.20,8.31,3.59,8.71z M15.29,3.59 c0.39-0.39,1.02-0.39,1.41,0l0.09,0.09C17.18,4,17.40,4.54,17.40,5c0,1.10-0.90,2-2,2c-0.23,0-0.45-0.04-0.66-0.11L14.50,7.17 c1,0.33,2,1.33,2.33,2.33l0.28-0.16C17.04,9.13,17,8.90,17,8.67c0-1.10,0.90-2,2-2c0.46,0,0.99,0.20,1.32,0.53l0.09,0.09 c0.39,0.39,1.02,0.39,1.41,0c0.39-0.39,0.39-1.02,0-1.41L21.71,3.59C21.32,3.20,20.78,3.20,20.39,3.59z M12,14c-2.21,0-4,1.79-4,4 s1.79,4,4,4s4-1.79,4-4S14.21,14,12,14z"/></svg>` :
                    `<svg class="w-full h-full text-amber-500 p-1" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5,14h-0.79l-0.28-0.27c1.2-1.4,1.82-3.31,1.48-5.34c-0.47-2.78-2.79-5-5.59-5.34c-4.23-0.52-7.79,3.04-7.27,7.27 c0.34,2.8,2.56,5.12,5.34,5.59c2.03,0.34,3.94-0.28,5.34-1.48L14,14.47V15.5l5,5l1.5-1.5L15.5,14z M9.5,14C7.01,14,5,11.99,5,9.5 C5,7.01,7.01,5,9.5,5S14,7.01,14,9.5C14,11.99,11.99,14,9.5,14z"/></svg>`;
                icon.innerHTML = catIcon;

                const bubble = document.createElement('div');
                bubble.className = 'p-3 rounded-2xl bg-[var(--gemini-bubble)] border border-gray-100 flex items-center gap-3';
                const dots = document.createElement('div');
                dots.className = 'dot-flashing';
                const loadingText = document.createElement('span');
                loadingText.className = 'text-sm text-[var(--text-secondary)] italic';
                const messages = loadingMessages[appState.mode] || ["è«‹ç¨å€™..."];
                loadingText.textContent = customMessage || messages[Math.floor(Math.random() * messages.length)];

                bubble.appendChild(dots);
                bubble.appendChild(loadingText);
                messageWrapper.appendChild(icon);
                messageWrapper.appendChild(bubble);
                chatHistory.appendChild(messageWrapper);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }

        function renderQuickReplies(replies) {
            clearQuickReplies();
            replies.forEach(reply => {
                const button = document.createElement('button');
                button.className = "bg-gray-100 hover:bg-[var(--accent-primary-hover)] hover:text-white text-sm text-[var(--text-secondary)] font-medium py-1.5 px-3 rounded-full transition-all border border-gray-200";
                button.textContent = reply;
                button.onclick = () => sendMessage(reply);
                quickRepliesContainer.appendChild(button);
            });
        }

        function clearQuickReplies() {
            quickRepliesContainer.innerHTML = '';
        }

        function displayReport(reportData) {
            let formattedSummary = reportData.summary
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-purple-600">$1</strong>');
            reportSummary.innerHTML = `<p>${formattedSummary}</p>`;
            
            // å…ˆé¡¯ç¤ºå½ˆçª—ï¼Œä¸è¦ç›´æ¥åˆ‡æ›åˆ° dashboard
            showResultModal();
            
            // å„²å­˜æ•¸æ“šä¾›å¾ŒçºŒä½¿ç”¨
            window.currentReportData = reportData;
        }

    </script>
</body>
</html>
